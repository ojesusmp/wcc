<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0e14">
<title>WCC v15.0</title>
<style>
:root{--bg:#0a0e14;--sf:#111620;--sf2:#181e2a;--sf3:#1f2736;--bd:#263044;--bdl:#344058;--tx:#e2e6f0;--txd:#8892a6;--txm:#5a6478;--cy:#00ccee;--cybg:rgba(0,204,238,.08);--gn:#00d68f;--gnbg:rgba(0,214,143,.08);--pu:#a78bfa;--pubg:rgba(167,139,250,.08);--rd:#f04444;--rdbg:rgba(240,68,68,.08);--or:#f59e0b;--orbg:rgba(245,158,11,.08);--bl:#3b82f6;--r:10px;--rs:6px;--st:env(safe-area-inset-top,0px);--sb:env(safe-area-inset-bottom,0px);--hh:54px;--nh:58px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',system-ui,sans-serif;background:var(--bg);color:var(--tx);font-size:15px;line-height:1.45;-webkit-user-select:none;user-select:none}
input,textarea,select{-webkit-user-select:text;user-select:text}
#app{display:flex;flex-direction:column;height:100dvh;padding-top:var(--st);padding-bottom:var(--sb)}
#hdr{height:var(--hh);min-height:var(--hh);display:flex;align-items:center;padding:0 16px;background:var(--sf);border-bottom:1px solid var(--bd);gap:10px;z-index:50}
#hbk{display:none;width:34px;height:34px;border:0;background:0;color:var(--cy);font-size:22px;cursor:pointer;align-items:center;justify-content:center}#hbk.v{display:flex}
#htl{flex:1;font-size:17px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#hvr{font-size:10px;color:var(--txm);background:var(--sf2);padding:2px 7px;border-radius:4px}
#mc{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
#bn{height:var(--nh);min-height:var(--nh);display:flex;background:var(--sf);border-top:1px solid var(--bd);z-index:50}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:0;background:0;color:var(--txm);font-size:10px;font-weight:500;cursor:pointer;position:relative}.nb .ni{font-size:20px}.nb.a{color:var(--cy)}
.nb .bg{position:absolute;top:4px;right:calc(50% - 16px);min-width:15px;height:15px;background:var(--rd);color:#fff;font-size:9px;font-weight:700;border-radius:8px;display:none;align-items:center;justify-content:center;padding:0 3px}.nb .bg.v{display:flex}
.S{display:none;padding:16px}.S.a{display:block}
.sl{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--txm);margin-bottom:10px}
.cd{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:16px;margin-bottom:10px}
.tg{display:inline-flex;align-items:center;font-size:11px;font-weight:600;padding:2px 7px;border-radius:4px}
.tW{background:var(--cybg);color:var(--cy)}.tC{background:var(--pubg);color:var(--pu)}.tP{background:var(--gnbg);color:var(--gn)}.tI{background:var(--rdbg);color:var(--rd)}
.bt{display:inline-flex;align-items:center;justify-content:center;gap:6px;height:44px;padding:0 20px;border:0;border-radius:var(--rs);font-size:14px;font-weight:600;cursor:pointer;white-space:nowrap}
.bp{background:var(--cy);color:#000}.bs{background:var(--sf2);color:var(--tx);border:1px solid var(--bd)}.bd{background:var(--rd);color:#fff}.bG{background:var(--gn);color:#000}.bF{width:100%}.bS{height:36px;padding:0 14px;font-size:13px}
.fg{margin-bottom:14px}.fl{display:block;font-size:12px;font-weight:600;color:var(--txd);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.fi{width:100%;height:44px;padding:0 12px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);color:var(--tx);font-size:15px;font-family:inherit;outline:0}.fi:focus{border-color:var(--cy)}
.fT{width:100%;min-height:80px;padding:10px 12px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);color:var(--tx);font-size:15px;font-family:inherit;outline:0;resize:vertical}.fT:focus{border-color:var(--cy)}
.fS{width:100%;height:44px;padding:0 12px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);color:var(--tx);font-size:15px;font-family:inherit;outline:0;-webkit-appearance:none}.fS:focus{border-color:var(--cy)}
#ci{width:100%;height:52px;padding:0 16px;background:var(--sf);border:2px solid var(--bd);border-radius:var(--r);color:var(--tx);font-size:16px;font-family:inherit;outline:0}#ci:focus{border-color:var(--cy)}#ci::placeholder{color:var(--txm)}
.ts{display:flex;gap:6px;margin-top:10px}.tb{flex:1;height:40px;border:1px solid var(--bd);border-radius:var(--rs);background:var(--sf2);color:var(--txd);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center}
.tb.sW{border-color:var(--cy);background:var(--cybg);color:var(--cy)}.tb.sC{border-color:var(--pu);background:var(--pubg);color:var(--pu)}.tb.sP{border-color:var(--gn);background:var(--gnbg);color:var(--gn)}.tb.sI{border-color:var(--rd);background:var(--rdbg);color:var(--rd)}
.ei{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:14px;margin-bottom:8px;cursor:pointer}.ei.xI{border-left:3px solid var(--rd)}
.pi{background:var(--sf);border:1px solid var(--or);border-radius:var(--r);padding:14px;margin-bottom:8px}
.ob{background:var(--sf2);border:1px solid var(--bd);border-radius:var(--r);padding:14px;margin-bottom:10px;position:relative}
.ob .od{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}.ob .ot{font-size:14px;color:var(--txd);line-height:1.5;white-space:pre-wrap}
.ob .cb{position:absolute;top:10px;right:10px;width:32px;height:32px;border:1px solid var(--bd);border-radius:var(--rs);background:var(--sf);color:var(--txd);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}.ob .cb.ok{background:var(--gn);color:#000;border-color:var(--gn)}
.dv{border:0;border-top:1px dashed var(--bd);margin:16px 0}
.edv{text-align:center;padding:10px 0;font-size:11px;font-weight:600;color:var(--txm);letter-spacing:2px;border-top:2px dashed var(--bd);border-bottom:2px dashed var(--bd);margin:14px 0}
#tst{position:fixed;bottom:calc(var(--nh)+var(--sb)+16px);left:50%;transform:translateX(-50%) translateY(80px);background:var(--sf2);border:1px solid var(--bd);color:var(--tx);padding:10px 20px;border-radius:var(--r);font-size:14px;font-weight:500;z-index:200;opacity:0;transition:all .3s;pointer-events:none}#tst.v{opacity:1;transform:translateX(-50%) translateY(0)}
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:flex-end;justify-content:center}.mo.v{display:flex}
.ms{width:100%;max-width:500px;max-height:80vh;background:var(--sf);border-radius:16px 16px 0 0;padding:20px 16px calc(20px+var(--sb));overflow-y:auto}.ms .mh{width:36px;height:4px;background:var(--bdl);border-radius:2px;margin:0 auto 16px}.ms h3{font-size:17px;font-weight:600;margin-bottom:4px}.ms p{font-size:13px;color:var(--txd);margin-bottom:16px}
.oB{width:100%;padding:14px 16px;background:var(--sf2);border:1px solid var(--bd);border-radius:var(--rs);color:var(--tx);font-size:15px;font-weight:500;text-align:left;cursor:pointer;margin-bottom:6px}.oB:active{background:var(--sf3);border-color:var(--cy)}
.fb{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto}.ft{height:32px;padding:0 14px;border:1px solid var(--bd);border-radius:16px;background:0;color:var(--txd);font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap}.ft.a{background:var(--cybg);border-color:var(--cy);color:var(--cy)}
.ib{padding:10px 14px;border-radius:var(--rs);font-size:13px;margin-bottom:14px;line-height:1.4}.iC{background:var(--cybg);color:var(--cy);border:1px solid rgba(0,204,238,.15)}.iR{background:var(--rdbg);color:var(--rd);border:1px solid rgba(240,68,68,.15)}.iO{background:var(--orbg);color:var(--or);border:1px solid rgba(245,158,11,.15)}
.si{display:flex;align-items:center;padding:14px 16px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);margin-bottom:6px;cursor:pointer;gap:12px}.si:active{background:var(--sf2)}.si .I{font-size:20px;width:28px;text-align:center}.si .T{flex:1}.si .L{font-size:15px;font-weight:500}.si .U{font-size:12px;color:var(--txm)}.si .A{color:var(--txm);font-size:18px}
.cA{background:var(--cybg);color:var(--cy);font-size:10px;padding:2px 6px;border-radius:3px;font-weight:600}.cB{background:var(--rdbg);color:var(--rd);font-size:10px;padding:2px 6px;border-radius:3px;font-weight:600}
.pr{display:flex;align-items:center;padding:10px 14px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--rs);margin-bottom:4px;gap:10px;cursor:pointer}.pr .N{flex:1;font-size:14px;font-weight:500}.pr .M{font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px}
.mV{background:var(--cybg);color:var(--cy)}.mW{background:var(--pubg);color:var(--pu)}.mS{background:var(--orbg);color:var(--or)}
.es{text-align:center;padding:40px 20px;color:var(--txm)}.spc{height:20px}
#lk{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;padding:20px}#lk.h{display:none}
#lkp{width:200px;height:50px;text-align:center;font-size:24px;letter-spacing:8px;background:var(--sf);border:2px solid var(--bd);border-radius:var(--r);color:var(--tx);outline:0}#lkp:focus{border-color:var(--cy)}
</style>
</head>
<body>
<div id="lk"><div style="font-size:48px;margin-bottom:20px;opacity:.6">&#x1f512;</div><h2 style="font-size:20px;font-weight:600;margin-bottom:4px">WCC v15.0</h2><div style="font-size:13px;color:var(--txm);margin-bottom:24px">Work Command Center</div><input type="password" id="lkp" maxlength="6" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;" inputmode="numeric" autocomplete="off"><div id="lke" style="color:var(--rd);font-size:13px;margin-top:10px"></div></div>
<div id="app" style="display:none">
<header id="hdr"><button id="hbk" onclick="goBack()">&#8249;</button><div id="htl">WCC</div><span id="hvr">v15.0</span></header>
<main id="mc"></main>
<nav id="bn">
<button class="nb a" onclick="nav('home')" data-s="home"><span class="ni">&#x1f4f1;</span><span>Home</span><span class="bg" id="pBg">0</span></button>
<button class="nb" onclick="nav('out')" data-s="out"><span class="ni">&#x1f4e4;</span><span>Output</span></button>
<button class="nb" onclick="nav('ent')" data-s="ent"><span class="ni">&#x1f4dd;</span><span>Entries</span></button>
<button class="nb" onclick="nav('set')" data-s="set"><span class="ni">&#x2699;&#xfe0f;</span><span>Settings</span></button>
</nav>
</div>
<div id="tst"></div>
<div class="mo" id="mPW"><div class="ms"><div class="mh"></div><h3>Where was this reported?</h3><p>Select the group where this issue originated.</p><div id="pwO"></div><button class="oB" onclick="selPW('tkt')" style="margin-top:6px;color:var(--txm)">Ticket Only</button><button class="oB" onclick="selPW('skip')" style="color:var(--txm)">Skip</button></div></div>
<div class="mo" id="mDP"><div class="ms"><div class="mh"></div><h3>Did you post this?</h3><p id="dpT"></p><div style="display:flex;flex-direction:column;gap:6px"><button class="bt bG bF" onclick="cfmP('yes')">&#x2713; Yes, I posted it</button><button class="bt bs bF" onclick="cfmP('ny')" style="border-color:var(--or);color:var(--or)">&#x23f3; Not Yet</button><button class="bt bs bF" onclick="cfmP('skip')">Skip</button></div></div></div>
<div class="mo" id="mAm"><div class="ms"><div class="mh"></div><h3>Which practice?</h3><p id="amT"></p><div id="amO"></div></div></div>

<script>
// ===== MARKET STRUCTURE =====
const MK={VID_DUB:{n:"Vidalia/Dublin",d:"Mark Ruff"},WAY:{n:"Waycross",d:"Christina Miller"},SAVANNAH_SATELLITE:{n:"Savannah Satellite",d:null,sp:1}};
const PRO_DEF={name:"Orlando Molina",title:"Technical Analyst II",mgr:"Walter Lopez"};

// ===== DEFAULT PRACTICES =====
const DP=[
{id:"HC_VID",n:"HeartCare",c:"Vidalia",m:"VID_DUB",pm:"Tina Watson",co:"",sc:["HC","HeartCare","Heartcare"],sat:[{l:"Hazelhurst",sc:["Hazelhurst-HC","HZL-HC"]}]},
{id:"SC_VID",n:"Surgical Care",c:"Vidalia",m:"VID_DUB",pm:"Elizabeth Edge",co:"",sc:["SC","Surgical","SurgCare"]},
{id:"SLC_VID",n:"Sleep & Lung Care",c:"Vidalia",m:"VID_DUB",pm:"Elizabeth Edge",co:"",sc:["SLC","SleepLung","Lung"]},
{id:"URO_VID",n:"Urology Care",c:"Vidalia",m:"VID_DUB",pm:"Lauren Smith",co:"",sc:["URO","Urology","LucyPearson","LP"]},
{id:"WC_VID",n:"Women's Center",c:"Vidalia",m:"VID_DUB",pm:"Laura Williamson",co:"23865",sc:["WC","WomensCtr","WomensCenter"],sat:[{l:"Hazelhurst",sc:["Hazelhurst-WC","HZL-WC"]}]},
{id:"CC_VID",n:"Children's Center",c:"Vidalia",m:"VID_DUB",pm:"Michelle Maybin",co:"23868",sc:["CC","ChildrensCtr","Peds"]},
{id:"RTS_VID",n:"RT Stanley Adult Primary Care",c:"Lyons",m:"VID_DUB",pm:"Lisa Bush",co:"",sc:["RTS","RTStanley","Lyons"]},
{id:"FBG_DUB",n:"Fairview Bariatrics / General Surgery",c:"Dublin",m:"VID_DUB",pm:"Amanda Spivey",co:"22470",sc:["FBG","Bariatrics","FairviewBari","FairviewGen"]},
{id:"FG_DUB",n:"Fairview Gastroenterology",c:"Dublin",m:"VID_DUB",pm:"Melony Faulk",co:"",sc:["FG","Gastro","FairviewGastro"]},
{id:"HROB_DUB",n:"HROB Dublin",c:"Dublin",m:"SAVANNAH_SATELLITE",pm:"",co:"",sc:["HROB","HROBDublin"],sp:1},
{id:"ANNEX_VID",n:"Annex Building",c:"Vidalia",m:"VID_DUB",pm:"",co:"",sc:["Annex","AnnexBldg"]},
{id:"HOSP_VID",n:"Memorial Meadows Hospital",c:"Vidalia",m:"VID_DUB",pm:"",co:"",sc:["Hospital","Meadows","MMH"]},
{id:"MSC_WAY",n:"Memorial Satilla Cardiology",c:"Waycross",m:"WAY",pm:"Jill Studstill",co:"23209",sc:["MSC","SatillaCardio","Cardio-WX"]},
{id:"MSN_WAY",n:"Memorial Satilla Neurology",c:"Waycross",m:"WAY",pm:"Jill Studstill",co:"23214",sc:["MSN","SatillaNeuro","Neuro-WX"]},
{id:"MSP_WAY",n:"Memorial Satilla Pulmonology",c:"Waycross",m:"WAY",pm:"Jill Studstill",co:"23219",sc:["MSP","SatillaPulmo","Pulmo-WX"]},
{id:"MSGS_WAY",n:"Memorial Satilla General Surgery",c:"Waycross",m:"WAY",pm:"Cambria Deal",co:"23211",sc:["MSGS","SatillaSurg","GenSurg-WX"]},
{id:"MSO_WAY",n:"Memorial Satilla Orthopedics",c:"Waycross",m:"WAY",pm:"",co:"",sc:["MSO","SatillaOrtho","Ortho-WX"]},
{id:"MSHSP_WAY",n:"Memorial Satilla Hospital",c:"Waycross",m:"WAY",pm:"",co:"",sc:["SatillaHosp","MSH-WX"]}
];
const DWG=["Hazelhurst Group","Vidalia Group","Dublin Group","Waycross Group","Direct Message","Email","Other"];

// ===== DB =====
let db;
const opDB=()=>new Promise((ok,no)=>{const r=indexedDB.open('wcc15',1);r.onupgradeneeded=e=>{const d=e.target.result;['entries','practices','settings','pending','commlog'].forEach(s=>{if(!d.objectStoreNames.contains(s))d.createObjectStore(s,{keyPath:s==='settings'?'k':'id'})})};r.onsuccess=e=>{db=e.target.result;ok()};r.onerror=e=>no(e)});
const P=(s,d)=>new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).put(d);t.oncomplete=ok;t.onerror=no});
const G=(s,k)=>new Promise((ok,no)=>{const r=db.transaction(s).objectStore(s).get(k);r.onsuccess=()=>ok(r.result);r.onerror=no});
const A=s=>new Promise((ok,no)=>{const r=db.transaction(s).objectStore(s).getAll();r.onsuccess=()=>ok(r.result||[]);r.onerror=no});
const D=(s,k)=>new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).delete(k);t.oncomplete=ok;t.onerror=no});
const C=s=>new Promise((ok,no)=>{const t=db.transaction(s,'readwrite');t.objectStore(s).clear();t.oncomplete=ok;t.onerror=no});

// ===== SHORTCODE ENGINE =====
let PC=[],SM={},AM={};
async function bSM(){PC=await A('practices');SM={};AM={};const lm={};
for(const p of PC){for(const s of(p.sc||[])){const k=s.toLowerCase();if(SM[k]){if(!AM[k])AM[k]=[SM[k]];AM[k].push(p);delete SM[k]}else if(!AM[k])SM[k]=p}
if(p.sat)for(const st of p.sat){for(const s of(st.sc||[]))SM[s.toLowerCase()]={...p,_s:st.l};const lk=st.l.toLowerCase();if(!lm[lk])lm[lk]=[];lm[lk].push({p,st})}}
for(const[l,a]of Object.entries(lm))if(a.length>1&&!SM[l])AM[l]=a.map(x=>({...x.p,_s:x.st.l}))}
function rSC(i){const k=i.trim().toLowerCase();if(SM[k])return{ok:1,p:SM[k]};if(AM[k])return{ok:0,am:1,o:AM[k],l:i};return{ok:0}}
function gDir(p){const m=MK[p.m];return(m&&!m.sp&&!p.sp)?m.d:null}
function mNm(id){return MK[id]?MK[id].n:id}
function isA(e){return(e.tp||'W')!=='I'}

// ===== INIT =====
async function init(){await opDB();if(!(await A('practices')).length)for(const p of DP)await P('practices',p);
if(!await G('settings','pro'))await P('settings',{k:'pro',...PRO_DEF});
if(!await G('settings','wxg'))await P('settings',{k:'wxg',g:[...DWG]});
await bSM();const pd=await G('settings','pin');
if(pd&&pd.v){document.getElementById('lk').classList.remove('h');const pi=document.getElementById('lkp');pi.focus();pi.onkeyup=()=>{if(pi.value.length>=4){if(pi.value===pd.v){document.getElementById('lk').classList.add('h');document.getElementById('app').style.display='flex';nav('home')}else{document.getElementById('lke').textContent='Wrong PIN';pi.value=''}}}}
else{document.getElementById('lk').classList.add('h');document.getElementById('app').style.display='flex';nav('home')}}

// ===== NAV =====
let stk=['home'],cur='home',_of='today',_ef='today';
const TT={home:'WCC',out:'Output Hub',wx:'WebEx Close-Outs',tk:'ServiceNow Ticket',em:'PM + Director Email',eod:'EOD Report',sn:'Sentinel Export',ent:'Entries',set:'Settings',pro:'Profile',prc:'Practices',ep:'Edit Practice',wxg:'WebEx Groups',sec:'Security',dat:'Data Management',ee:'Edit Entry'};
function go(id){document.getElementById('mc').innerHTML=screens[id]?screens[id]():'';if(id!==cur)stk.push(id);cur=id;document.getElementById('htl').textContent=TT[id]||'WCC';document.getElementById('hbk').classList.toggle('v',!['home','out','ent','set'].includes(id));document.getElementById('mc').scrollTop=0;if(renders[id])renders[id]()}
function nav(id){stk=[id];go(id);document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('a',b.dataset.s===id))}
function goBack(){if(stk.length>1){stk.pop();go(stk[stk.length-1]);const p=stk[stk.length-1];if(['home','out','ent','set'].includes(p))document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('a',b.dataset.s===p))}}

// ===== HELPERS =====
function toast(m){const t=document.getElementById('tst');t.textContent=m;t.classList.add('v');setTimeout(()=>t.classList.remove('v'),2000)}
async function cp(t){try{await navigator.clipboard.writeText(t);return 1}catch{const a=document.createElement('textarea');a.value=t;a.style.cssText='position:fixed;left:-9999px';document.body.appendChild(a);a.select();document.execCommand('copy');document.body.removeChild(a);return 1}}
function H(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):''}
function tdy(){const d=new Date();return[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-')}
function wkS(){const d=new Date(),dy=d.getDay(),df=d.getDate()-dy+(dy===0?-6:1);d.setDate(df);return[d.getFullYear(),String(d.getMonth()+1).padStart(2,'0'),String(d.getDate()).padStart(2,'0')].join('-')}
function fT(ts){return ts?new Date(ts).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:1}):''}
function fD(s){return s?new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}):''}
function fDF(s){return s?new Date(s+'T12:00:00').toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}):''}
let _tp='W',_et='W',_pe=null,_eeid=null,_epid=null;

// ===== CLOSE-OUT TEXT =====
function genCO(e){let t=(e.pn||'')+':\n';if(e.tk)t+=e.tk+' \u2014 ';t+=(e.prob||'');if(e.act)t+=' \u2014 '+e.act;if(e.res)t+=' \u2014 '+e.res;t+='.';return t}

// ===== ENTRY CARD HTML =====
function eCard(e){const ic=e.tp==='I'?' xI':'',tg='<span class="tg t'+(e.tp||'W')+'">'+(e.tp||'W')+(e.tp==='I'?' &#x1f512;':'')+'</span>',po=e.posted?'<span style="color:var(--gn);font-size:11px;font-weight:600">&#x2713; POSTED</span>':'';
return'<div class="ei'+ic+'" onclick="edE(\''+e.id+'\')"><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap">'+tg+'<span style="font-size:13px;font-weight:600;color:var(--cy)">'+H(e.pn)+'</span><span style="font-size:12px;color:var(--txm)">'+fT(e.ts)+'</span>'+po+'</div><div style="font-size:14px;color:var(--txd);line-height:1.4">'+H(e.prob)+(e.act?' \u2014 '+H(e.act):'')+(e.res?' \u2014 '+H(e.res):'')+'</div>'+(e.tk?'<div style="font-size:12px;color:var(--or);margin-top:4px">&#x1f3ab; '+H(e.tk)+'</div>':'')+'</div>'}

// ===== SCREEN TEMPLATES =====
const screens={
home:()=>'<div id="pSec"></div><div class="sl">Quick Capture</div><input type="text" id="ci" placeholder="HC / problem / action / result" autocomplete="off" autocapitalize="sentences"><div class="ts" id="tS"><button class="tb sW" data-t="W" onclick="selT(\'W\')">W</button><button class="tb" data-t="C" onclick="selT(\'C\')">C</button><button class="tb" data-t="P" onclick="selT(\'P\')">P</button><button class="tb" data-t="I" onclick="selT(\'I\')">I</button></div><div style="display:flex;gap:6px;margin-top:10px"><input type="text" class="fi" id="cTk" placeholder="Ticket # (optional)" style="flex:1;height:38px;font-size:14px"><button class="bt bp bS" onclick="saveE()" style="min-width:80px">Save</button></div><div id="incW" style="display:none" class="ib iR">&#x1f512; Incident \u2014 Channel B only.</div><hr class="dv"><div class="sl">Today\'s Entries</div><div id="tL"></div><div class="spc"></div>',

out:()=>'<div class="sl">Output Hub \u2014 One-Tap Generation</div><div class="fb"><button class="ft a" onclick="setOF(\'today\',this)">Today</button><button class="ft" onclick="setOF(\'week\',this)">This Week</button></div>'+
[['wx','&#x1f4ac;','Group Close-Out','Per-item WebEx messages','cA','CH-A'],
['tk','&#x1f3ab;','ServiceNow Ticket','Full technical detail','cA','CH-A'],
['em','&#x1f4e7;','PM + Director Email','Stacked, per-market','cA','CH-A'],
['eod','&#x1f4cb;','EOD / Friday Report','Always includes Walter','cA','CH-A'],
['sn','&#x1f512;','Sentinel Export','Channel B \u2014 Evidence JSON','cB','CH-B']].map(x=>'<button class="si"'+(x[0]==='sn'?' style="border-color:rgba(240,68,68,.3)"':'')+' onclick="go(\''+x[0]+'\')"><span class="I">'+x[1]+'</span><span class="T"><span class="L">'+x[2]+'</span><br><span class="U">'+x[3]+'</span></span><span class="'+x[4]+'">'+x[5]+'</span><span class="A">&#x203a;</span></button>').join('')+'<div class="spc"></div>',

wx:()=>'<div class="ib iC">&#x1f4ac; Per-item close-outs \u2014 Incidents excluded</div><div id="wxO"></div><button class="bt bp bF" onclick="cpAW()" style="margin-top:10px">Copy All Close-Outs</button><div class="spc"></div>',
tk:()=>'<div class="ib iC">&#x1f3ab; ServiceNow ticket notes</div><div id="tkO"></div><div class="spc"></div>',
em:()=>'<div class="ib iC">&#x1f4e7; PM + Director emails \u2014 Per market</div><div id="emO"></div><button class="bt bp bF" onclick="cpAE()" style="margin-top:10px">Copy All Emails</button><div class="spc"></div>',
eod:()=>'<div class="ib iC">&#x1f4cb; EOD Report \u2014 Always includes Walter Lopez</div><div id="eodO"></div><button class="bt bp bF" onclick="cpEOD()" style="margin-top:10px">Copy EOD Report</button><div class="spc"></div>',
sn:()=>'<div style="background:var(--rdbg);border:2px solid var(--rd);border-radius:var(--r);padding:14px;text-align:center;margin-bottom:14px"><div style="font-size:14px;font-weight:700;color:var(--rd);margin-bottom:4px">&#x1f512; CHANNEL B \u2014 Private</div><div style="font-size:12px;color:var(--rd);opacity:.8">Never paste into WebEx, email, or group chat</div></div><div id="snO"></div><button class="bt bd bF" onclick="cpSn()" style="margin-top:10px">Copy Sentinel JSON</button><div class="spc"></div>',

ent:()=>'<div class="sl">All Entries</div><div class="fb" id="eFl"><button class="ft a" onclick="setEF(\'today\',this)">Today</button><button class="ft" onclick="setEF(\'week\',this)">This Week</button><button class="ft" onclick="setEF(\'all\',this)">All</button></div><div id="eL"></div><div class="spc"></div>',

set:()=>'<div class="sl">Settings</div>'+[['pro','&#x1f464;','Profile & Signature','Name, title, email sig'],['prc','&#x1f3e5;','Practices & Markets','Locations, PMs, shortcodes'],['wxg','&#x1f4ac;','WebEx Groups','Group chat names'],['sec','&#x1f512;','Security','PIN code'],['dat','&#x1f4be;','Data Management','Backup, restore, clear']].map(x=>'<button class="si" onclick="go(\''+x[0]+'\')"><span class="I">'+x[1]+'</span><span class="T"><span class="L">'+x[2]+'</span><br><span class="U">'+x[3]+'</span></span><span class="A">&#x203a;</span></button>').join('')+'<div class="spc"></div>',

pro:()=>'<div class="sl">Profile & Email Signature</div><div class="cd"><div class="fg"><label class="fl">Full Name</label><input type="text" class="fi" id="prN"></div><div class="fg"><label class="fl">Title</label><input type="text" class="fi" id="prT"></div><div class="fg"><label class="fl">Manager (EOD Recipient)</label><input type="text" class="fi" id="prM"></div><button class="bt bp bF" onclick="savePro()">Save Profile</button></div>',

prc:()=>'<div class="sl">Practices & Markets</div><div class="ib iC">Tap a practice to edit.</div><div id="prcL"></div><button class="bt bs bF" onclick="addPrc()" style="margin-top:10px">+ Add Practice</button><div class="spc"></div>',

ep:()=>'<div class="sl" id="epL">Edit Practice</div><div class="cd"><div class="fg"><label class="fl">Practice Name</label><input type="text" class="fi" id="epN"></div><div class="fg"><label class="fl">City</label><input type="text" class="fi" id="epC"></div><div class="fg"><label class="fl">Market</label><select class="fS" id="epM"><option value="VID_DUB">Vidalia/Dublin</option><option value="WAY">Waycross</option><option value="SAVANNAH_SATELLITE">Savannah Satellite</option></select></div><div class="fg"><label class="fl">Practice Manager</label><input type="text" class="fi" id="epPM"></div><div class="fg"><label class="fl">COID</label><input type="text" class="fi" id="epCO"></div><div class="fg"><label class="fl">Shortcodes (comma-separated)</label><input type="text" class="fi" id="epSC"></div><div class="fg"><label class="fl">Notes</label><textarea class="fT" id="epNo" rows="3"></textarea></div><button class="bt bp bF" onclick="savePrc2()">Save</button><button class="bt bd bF" onclick="delPrc()" style="margin-top:8px" id="epD">Delete</button></div><div class="spc"></div>',

wxg:()=>'<div class="sl">WebEx Groups</div><div class="ib iC">Configure group names for "Post Where It Started".</div><div id="wxGL"></div><div class="fg" style="margin-top:12px"><input type="text" class="fi" id="nWG" placeholder="New group name..."></div><button class="bt bs bF" onclick="addWG()">+ Add Group</button><div class="spc"></div>',

sec:()=>'<div class="sl">Security</div><div class="cd"><div class="fg"><label class="fl">New PIN (4-6 digits)</label><input type="password" class="fi" id="sP" inputmode="numeric" maxlength="6"></div><div class="fg"><label class="fl">Confirm PIN</label><input type="password" class="fi" id="sPC" inputmode="numeric" maxlength="6"></div><button class="bt bp bF" onclick="savePin()">Save PIN</button><button class="bt bs bF" onclick="rmPin()" style="margin-top:8px">Remove PIN</button></div>',

dat:()=>'<div class="sl">Data Management</div><button class="si" onclick="expB()"><span class="I">&#x1f4e4;</span><span class="T"><span class="L">Export Backup</span><br><span class="U">Download JSON</span></span></button><button class="si" onclick="document.getElementById(\'impF\').click()"><span class="I">&#x1f4e5;</span><span class="T"><span class="L">Import Backup</span><br><span class="U">Restore from JSON</span></span></button><input type="file" id="impF" accept=".json" style="display:none" onchange="impB(event)"><hr class="dv"><button class="si" style="border-color:rgba(240,68,68,.3)" onclick="clrAll()"><span class="I">&#x1f5d1;</span><span class="T"><span class="L" style="color:var(--rd)">Clear All Data</span><br><span class="U">Permanently delete everything</span></span></button>',

ee:()=>'<div class="sl">Edit Entry</div><div class="cd"><div class="fg"><label class="fl">Location</label><input type="text" class="fi" id="eeL"></div><div class="fg"><label class="fl">Problem</label><input type="text" class="fi" id="eeP"></div><div class="fg"><label class="fl">Action</label><input type="text" class="fi" id="eeA"></div><div class="fg"><label class="fl">Result</label><input type="text" class="fi" id="eeR"></div><div class="fg"><label class="fl">Entry Type</label><div class="ts" id="eeTS"><button class="tb" data-t="W" onclick="selET(\'W\')">W</button><button class="tb" data-t="C" onclick="selET(\'C\')">C</button><button class="tb" data-t="P" onclick="selET(\'P\')">P</button><button class="tb" data-t="I" onclick="selET(\'I\')">I</button></div></div><div class="fg"><label class="fl">Ticket #</label><input type="text" class="fi" id="eeTk"></div><div class="fg"><label class="fl">Time</label><input type="time" class="fi" id="eeTm"></div><div class="fg"><label class="fl">Status</label><select class="fS" id="eeSt"><option value="resolved">Resolved</option><option value="in_progress">In Progress</option><option value="pending">Pending</option><option value="escalated">Escalated</option></select></div><button class="bt bp bF" onclick="saveEE()">Save Changes</button><button class="bt bd bF" onclick="delEE()" style="margin-top:8px">Delete Entry</button></div><div class="spc"></div>'
};

// ===== RENDER FUNCTIONS =====
const renders={
home:async()=>{const ci=document.getElementById('ci');if(ci)ci.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();saveE()}};_tp='W';
const ps=await A('pending'),pSec=document.getElementById('pSec'),pBg=document.getElementById('pBg');
if(ps.length){pBg.classList.add('v');pBg.textContent=ps.length;pSec.innerHTML='<div class="sl" style="color:var(--or)">&#x23f3; Unposted Close-Outs</div>'+ps.map(p=>'<div class="pi"><div style="font-size:11px;font-weight:600;color:var(--or);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px">&#x23f3; Unposted</div><div style="font-size:14px;font-weight:600;margin-bottom:4px">&rarr; '+H(p.dst)+'</div><div style="font-size:13px;color:var(--txd);margin-bottom:10px;white-space:pre-wrap">'+H(p.txt)+'</div><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="bt bG bS" onclick="resP(\''+p.id+"','"+p.eid+"',1)\">&#x2713; Posted</button><button class=\"bt bs bS\" onclick=\"cpP('"+p.id+"')\">&#x1f4cb; Copy</button><button class=\"bt bs bS\" onclick=\"resP('"+p.id+"','"+p.eid+"',0)\">Skip</button></div></div>").join('')+'<hr class="dv">'}else{pBg.classList.remove('v');pSec.innerHTML=''}
const all=await A('entries'),today=tdy(),ti=all.filter(e=>e.dt===today).sort((a,b)=>b.ts.localeCompare(a.ts)),tL=document.getElementById('tL');
tL.innerHTML=ti.length?ti.map(eCard).join(''):'<div class="es"><div style="font-size:40px;margin-bottom:12px;opacity:.5">&#x1f4dd;</div><div style="font-size:14px">No entries today. Use Quick Capture above.</div></div>'},

ent:async()=>{const all=await A('entries'),today=tdy(),wk=wkS();let f=all;if(_ef==='today')f=all.filter(e=>e.dt===today);else if(_ef==='week')f=all.filter(e=>e.dt>=wk);f.sort((a,b)=>b.ts.localeCompare(a.ts));document.getElementById('eL').innerHTML=f.length?f.map(eCard).join(''):'<div class="es"><div style="font-size:40px;margin-bottom:12px;opacity:.5">&#x1f4dd;</div><div style="font-size:14px">No entries found.</div></div>'},

wx:async()=>{const ents=await gFE(),res=ents.filter(e=>isA(e)&&e.st==='resolved'),c=document.getElementById('wxO');if(!res.length){c.innerHTML='<div class="es">No resolved Channel A entries.</div>';return}
c.innerHTML=res.map(e=>{const t=genCO(e);return'<div class="ob"><div class="od" style="color:var(--cy)">&#x1f4ac; '+H(e.pn)+'</div><div class="ot">'+H(t)+'</div><button class="cb" onclick="cpOB(this)">&#x1f4cb;</button></div>'}).join('')},

tk:async()=>{const ents=await gFE(),tk=ents.filter(e=>isA(e)&&e.tk),c=document.getElementById('tkO');if(!tk.length){c.innerHTML='<div class="es">No entries with ticket numbers.</div>';return}
c.innerHTML=tk.map(e=>{const t='Date: '+fDF(e.dt)+'\nTime: '+fT(e.ts)+'\nLocation: '+e.pn+', '+(e.city||'')+'\nCOID: '+(e.co||'N/A')+'\nTicket: '+e.tk+'\n\nIssue: '+e.prob+'\nAction: '+e.act+'\nResult: '+e.res;return'<div class="ob"><div class="od" style="color:var(--bl)">&#x1f3ab; '+H(e.tk)+'</div><div class="ot">'+H(t)+'</div><button class="cb" onclick="cpOB(this)">&#x1f4cb;</button></div>'}).join('')},

em:async()=>{const ents=await gFE(),pub=ents.filter(isA),prof=await G('settings','pro')||PRO_DEF,c=document.getElementById('emO');if(!pub.length){c.innerHTML='<div class="es">No Channel A entries.</div>';return}
const bm={};for(const e of pub){const m=e.mkt||'OTHER';if(!bm[m])bm[m]=[];bm[m].push(e)}
const dl=_of==='today'?fDF(tdy()):'Week of '+fD(wkS());let h='';
for(const[mid,me]of Object.entries(bm)){const mk=MK[mid],mn=mk?mk.n:mid,dn=mk?mk.d:null,rv=me.filter(e=>e.st==='resolved'),ip=me.filter(e=>e.st==='in_progress'),pn=me.filter(e=>e.st==='pending'||e.st==='escalated');
let pt='Daily Activity Report \u2014 '+dl+'\n'+mn+'\n\n';
if(rv.length){pt+='RESOLVED ('+rv.length+')\n';rv.forEach((e,i)=>{pt+=(i+1)+'. '+(e.tk?e.tk+' \u2013 ':'')+e.prob+' | '+e.pn+'\n';if(e.act)pt+='   - '+e.act+'\n';if(e.res)pt+='   - '+e.res+'\n'});pt+='\n'}
if(ip.length){pt+='IN PROGRESS ('+ip.length+')\n';ip.forEach((e,i)=>{pt+=(i+1)+'. '+(e.tk?e.tk+' \u2013 ':'')+e.prob+' | '+e.pn+'\n'});pt+='\n'}
if(pn.length){pt+='PENDING ('+pn.length+')\n';pn.forEach((e,i)=>{pt+=(i+1)+'. '+(e.tk?e.tk+' \u2013 ':'')+e.prob+' | '+e.pn+'\n'});pt+='\n'}
pt+=(prof.name||PRO_DEF.name)+'\n'+(prof.title||PRO_DEF.title);
h+='<div class="ob"><div class="od" style="color:var(--pu)">&#x1f4e7; PM VERSION \u2014 '+H(mn)+'</div><div class="ot">'+H(pt)+'</div><button class="cb" onclick="cpOB(this)">&#x1f4cb;</button></div>';
if(dn&&!(mk&&mk.sp)){const bp={};for(const e of me){const p=e.pn||'Other';if(!bp[p])bp[p]={r:0,t:0};bp[p].t++;if(e.st==='resolved')bp[p].r++}
let dt='Activity Summary \u2014 '+dl+'\n'+mn+'\n\nTickets: '+me.length+' total | '+rv.length+' resolved | '+ip.length+' in progress | '+pn.length+' pending\n\n';
for(const[p,s]of Object.entries(bp))dt+=p+': '+s.t+' item'+(s.t!==1?'s':'')+' ('+s.r+' resolved)\n';
dt+='\n'+(prof.name||PRO_DEF.name)+'\n'+(prof.title||PRO_DEF.title);
h+='<div class="edv">\u2550\u2550 DIRECTOR VERSION \u2550\u2550</div><div class="ob"><div class="od" style="color:var(--bl)">&#x1f4e7; DIRECTOR \u2014 '+H(dn)+'</div><div class="ot">'+H(dt)+'</div><button class="cb" onclick="cpOB(this)">&#x1f4cb;</button></div>'}
else if(mk&&mk.sp)h+='<div class="ib iO" style="margin:8px 0">\u26a0 '+H(mn)+': No director routing \u2014 EOD to Walter only.</div>';
h+='<hr class="dv">'}c.innerHTML=h},

eod:async()=>{const ents=await gFE(),pub=ents.filter(isA),prof=await G('settings','pro')||PRO_DEF,cls=await A('commlog'),today=tdy(),tl=cls.filter(c=>_of==='today'?c.dt===today:c.dt>=wkS()),dl=_of==='today'?fDF(tdy()):'Week of '+fD(wkS());
let t='EOD Report \u2014 '+dl+'\nTo: '+(prof.mgr||PRO_DEF.mgr)+'\nFrom: '+(prof.name||PRO_DEF.name)+'\n\n';
const bm={};for(const e of pub){const m=e.mkt||'OTHER';if(!bm[m])bm[m]={};const p=e.pn||'Other';if(!bm[m][p])bm[m][p]=[];bm[m][p].push(e)}
for(const[mid,pracs]of Object.entries(bm)){t+='\u2500\u2500 '+(MK[mid]?MK[mid].n:mid)+' \u2500\u2500\n\n';for(const[pn,items]of Object.entries(pracs)){t+=pn+':\n';for(const e of items)t+='  ['+fT(e.ts)+'] '+(e.tk?e.tk+' \u2014 ':'')+e.prob+(e.act?' \u2192 '+e.act:'')+(e.res?' \u2192 '+e.res:'')+' ('+e.st+')\n';t+='\n'}}
if(tl.length){t+='\u2500\u2500 Communications \u2500\u2500\n';for(const l of tl)t+='  ['+fT(l.ts)+'] '+l.dst+'\n';t+='\n'}
t+=(prof.name||PRO_DEF.name)+'\n'+(prof.title||PRO_DEF.title);
document.getElementById('eodO').innerHTML='<div class="ob"><div class="od">&#x1f4cb; EOD Report</div><div class="ot">'+H(t)+'</div></div>'},

sn:async()=>{const ents=await gFE(),cls=await A('commlog'),today=tdy(),inc=ents.filter(e=>!isA(e)),wk=ents.filter(isA);
const sn={schema:"wcc.sentinel.v15.0",generated:new Date().toISOString(),date_range:_of,channel_b_incidents:inc.map(e=>({id:e.id,ts:e.ts,loc:e.pn,prob:e.prob,act:e.act,res:e.res,tk:e.tk,st:e.st})),work_context:wk.map(e=>({id:e.id,ts:e.ts,tp:e.tp,loc:e.pn,prob:e.prob,act:e.act,res:e.res,tk:e.tk,st:e.st,posted:e.posted})),comm_log:cls.filter(c=>_of==='today'?c.dt===today:c.dt>=wkS()),summary:{incidents:inc.length,work:wk.length,total:ents.length}};
document.getElementById('snO').innerHTML='<div class="ob" style="border-color:rgba(240,68,68,.3)"><div class="od" style="color:var(--rd)">&#x1f512; Sentinel JSON</div><div class="ot" style="font-family:monospace;font-size:12px">'+H(JSON.stringify(sn,null,2))+'</div></div><div class="cd" style="margin-top:12px"><div style="font-weight:600">Summary</div><div style="font-size:13px;color:var(--txd)">Incidents: '+inc.length+' \u00b7 Work: '+wk.length+' \u00b7 Total: '+ents.length+'</div></div>'},

pro:async()=>{const p=await G('settings','pro')||PRO_DEF;document.getElementById('prN').value=p.name||'';document.getElementById('prT').value=p.title||'';document.getElementById('prM').value=p.mgr||''},

prc:async()=>{const ps=await A('practices'),c=document.getElementById('prcL');c.innerHTML=ps.sort((a,b)=>a.n.localeCompare(b.n)).map(p=>'<div class="pr" onclick="edPrc(\''+p.id+'\')"><div class="N">'+H(p.n)+'</div><span class="M '+(p.m==='VID_DUB'?'mV':p.m==='WAY'?'mW':'mS')+'">'+mNm(p.m)+'</span><span style="color:var(--txm)">&#x203a;</span></div>').join('')},

wxg:async()=>{const d=await G('settings','wxg'),gs=d?d.g:DWG;document.getElementById('wxGL').innerHTML=gs.map((g,i)=>'<div class="pr"><div class="N">'+H(g)+'</div><button style="background:0;border:0;color:var(--rd);font-size:18px;cursor:pointer" onclick="rmWG('+i+')">&times;</button></div>').join('')},

ee:async()=>{if(!_eeid)return;const e=await G('entries',_eeid);if(!e)return;_et=e.tp||'W';document.getElementById('eeL').value=e.locIn||e.pn||'';document.getElementById('eeP').value=e.prob||'';document.getElementById('eeA').value=e.act||'';document.getElementById('eeR').value=e.res||'';document.getElementById('eeTk').value=e.tk||'';document.getElementById('eeSt').value=e.st||'resolved';const ts=new Date(e.ts);document.getElementById('eeTm').value=String(ts.getHours()).padStart(2,'0')+':'+String(ts.getMinutes()).padStart(2,'0');selET(_et)}
};

// ===== ACTIONS =====
function selT(t){_tp=t;document.querySelectorAll('#tS .tb').forEach(b=>{b.className='tb'+(b.dataset.t===t?' s'+t:'')});const w=document.getElementById('incW');if(w)w.style.display=t==='I'?'block':'none'}
function selET(t){_et=t;document.querySelectorAll('#eeTS .tb').forEach(b=>{b.className='tb'+(b.dataset.t===t?' s'+t:'')})}
function setOF(m,b){_of=m;b.parentElement.querySelectorAll('.ft').forEach(x=>x.classList.remove('a'));b.classList.add('a')}
function setEF(m,b){_ef=m;b.parentElement.querySelectorAll('.ft').forEach(x=>x.classList.remove('a'));b.classList.add('a');renders.ent()}
async function gFE(){const all=await A('entries'),today=tdy(),wk=wkS();return(_of==='today'?all.filter(e=>e.dt===today):all.filter(e=>e.dt>=wk)).sort((a,b)=>a.ts.localeCompare(b.ts))}

// Save entry
async function saveE(){const raw=document.getElementById('ci').value.trim();if(!raw){toast('Enter something first');return}
const pts=raw.split('/').map(s=>s.trim()),li=pts[0]||'',prob=pts[1]||'',act=pts[2]||'',res=pts[3]||'',tk=document.getElementById('cTk').value.trim();
const r=rSC(li);if(r.am){_pe={raw,prob,act,res,tk,tp:_tp};document.getElementById('amT').textContent='"'+li+'" matches multiple practices:';const c=document.getElementById('amO');c.innerHTML='';for(const o of r.o){const b=document.createElement('button');b.className='oB';b.innerHTML=H(o.n)+'<div style="font-size:12px;color:var(--txm);margin-top:2px">'+(o.pm?'PM: '+H(o.pm):'')+'</div>';b.onclick=()=>resAm(o);c.appendChild(b)}document.getElementById('mAm').classList.add('v');return}
const p=r.ok?r.p:null,e=mkE(li,p,prob,act,res,tk,_tp);await P('entries',e);document.getElementById('ci').value='';document.getElementById('cTk').value='';
if(isA(e)&&e.st==='resolved'){_pe=e;showPW()}else{toast(isA(e)?'\u2713 Entry saved':'\ud83d\udd12 Incident logged (Channel B)');renders.home()}}

function mkE(li,p,prob,act,res,tk,tp){const sat=p?p._s:'';return{id:'e'+Date.now()+'_'+Math.random().toString(36).substr(2,5),dt:tdy(),ts:new Date().toISOString(),tp,locIn:li,pid:p?p.id:null,pn:p?(sat?p.n+' \u2014 '+sat:p.n):li,mkt:p?p.m:'',pm:p?p.pm:'',dir:p?gDir(p)||'':'',city:p?p.c:'',co:p?(p.co||''):'',prob,act,res,tk,st:res.toLowerCase().includes('pending')?'pending':res.toLowerCase().includes('progress')?'in_progress':res.toLowerCase().includes('escalat')?'escalated':'resolved',posted:false,postTs:''}}

async function resAm(p){document.getElementById('mAm').classList.remove('v');if(!_pe)return;const pe=_pe,e=mkE(pe.raw.split('/')[0]?.trim()||'',p,pe.prob,pe.act,pe.res,pe.tk,pe.tp);await P('entries',e);document.getElementById('ci').value='';document.getElementById('cTk').value='';
if(isA(e)&&e.st==='resolved'){_pe=e;showPW()}else{toast('\u2713 Entry saved');_pe=null;renders.home()}}

async function showPW(){const c=document.getElementById('pwO');c.innerHTML='';const d=await G('settings','wxg'),gs=d?d.g:DWG;for(const g of gs){const b=document.createElement('button');b.className='oB';b.textContent=g;b.onclick=()=>selPW(g);c.appendChild(b)}document.getElementById('mPW').classList.add('v')}
async function selPW(dst){document.getElementById('mPW').classList.remove('v');if(dst==='skip'||dst==='tkt'){toast('\u2713 Entry saved');_pe=null;renders.home();return}
const e=_pe;if(!e)return;const txt=genCO(e),pi={id:'p'+Date.now(),eid:e.id,dst,txt,pn:e.pn,cr:new Date().toISOString()};await P('pending',pi);await cp(txt);toast('\ud83d\udccb Copied! Ready to paste');
setTimeout(()=>{document.getElementById('dpT').textContent='Close-out for "'+e.pn+'" \u2192 '+dst;const m=document.getElementById('mDP');m.classList.add('v');m._pid=pi.id;m._eid=e.id},500)}
async function cfmP(a){const m=document.getElementById('mDP');m.classList.remove('v');const pid=m._pid,eid=m._eid;
if(a==='yes'){await D('pending',pid);const e=await G('entries',eid);if(e){e.posted=true;e.postTs=new Date().toISOString();await P('entries',e)}await P('commlog',{id:'c'+Date.now(),eid,dt:tdy(),ts:new Date().toISOString(),dst:document.getElementById('dpT').textContent});toast('\u2713 Posted \u2014 logged')}
else if(a==='ny')toast('\u23f3 Added to pending queue');
else{await D('pending',pid);toast('Skipped')}
_pe=null;renders.home()}

async function cpP(id){const i=await G('pending',id);if(i){await cp(i.txt);toast('\ud83d\udccb Copied')}}
async function resP(pid,eid,posted){if(posted){await D('pending',pid);const e=await G('entries',eid);if(e){e.posted=true;e.postTs=new Date().toISOString();await P('entries',e)}await P('commlog',{id:'c'+Date.now(),eid,dt:tdy(),ts:new Date().toISOString(),dst:'pending queue'});toast('\u2713 Marked as posted')}else{await D('pending',pid);toast('Removed')}renders.home()}

async function edE(id){_eeid=id;go('ee')}
async function saveEE(){if(!_eeid)return;const e=await G('entries',_eeid);if(!e)return;const li=document.getElementById('eeL').value.trim(),r=rSC(li),p=r.ok?r.p:null;
e.locIn=li;e.prob=document.getElementById('eeP').value.trim();e.act=document.getElementById('eeA').value.trim();e.res=document.getElementById('eeR').value.trim();e.tk=document.getElementById('eeTk').value.trim();e.tp=_et;e.st=document.getElementById('eeSt').value;
if(p){e.pid=p.id;e.pn=p._s?p.n+' \u2014 '+p._s:p.n;e.mkt=p.m;e.pm=p.pm||'';e.dir=gDir(p)||'';e.city=p.c||'';e.co=p.co||''}
const tp=document.getElementById('eeTm').value.split(':');if(tp.length===2){const d=new Date(e.ts);d.setHours(+tp[0],+tp[1]);e.ts=d.toISOString()}
await P('entries',e);toast('\u2713 Updated');goBack()}
async function delEE(){if(!_eeid||!confirm('Delete this entry?'))return;await D('entries',_eeid);_eeid=null;toast('Deleted');goBack()}

// Output copy helpers
async function cpOB(btn){const b=btn.parentElement.querySelector('.ot');if(b&&await cp(b.textContent)){btn.classList.add('ok');btn.textContent='\u2713';setTimeout(()=>{btn.classList.remove('ok');btn.textContent='\ud83d\udccb'},1500)}}
async function cpAW(){const ents=await gFE(),res=ents.filter(e=>isA(e)&&e.st==='resolved');if(await cp(res.map(genCO).join('\n\n')))toast('\ud83d\udccb All close-outs copied')}
async function cpAE(){const bs=document.querySelectorAll('#emO .ot');if(await cp(Array.from(bs).map(b=>b.textContent).join('\n\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n\n')))toast('\ud83d\udccb All emails copied')}
async function cpEOD(){const t=document.querySelector('#eodO .ot')?.textContent||'';if(await cp(t))toast('\ud83d\udccb EOD copied')}
async function cpSn(){const t=document.querySelector('#snO .ot')?.textContent||'';if(await cp(t))toast('\ud83d\udd12 Sentinel JSON copied')}

// Settings
async function savePro(){await P('settings',{k:'pro',name:document.getElementById('prN').value.trim(),title:document.getElementById('prT').value.trim(),mgr:document.getElementById('prM').value.trim()});toast('\u2713 Profile saved')}
async function edPrc(id){_epid=id;go('ep');const p=await G('practices',id);if(!p)return;document.getElementById('epL').textContent='Edit Practice';document.getElementById('epN').value=p.n||'';document.getElementById('epC').value=p.c||'';document.getElementById('epM').value=p.m||'VID_DUB';document.getElementById('epPM').value=p.pm||'';document.getElementById('epCO').value=p.co||'';document.getElementById('epSC').value=(p.sc||[]).join(', ');document.getElementById('epNo').value=p.notes||'';document.getElementById('epD').style.display='block'}
function addPrc(){_epid=null;go('ep');document.getElementById('epL').textContent='Add Practice';['epN','epC','epPM','epCO','epSC','epNo'].forEach(x=>document.getElementById(x).value='');document.getElementById('epM').value='VID_DUB';document.getElementById('epD').style.display='none'}
async function savePrc2(){const nm=document.getElementById('epN').value.trim();if(!nm){toast('Name required');return}const id=_epid||('p'+Date.now()),ex=_epid?await G('practices',_epid)||{}:{};
await P('practices',{...ex,id,n:nm,c:document.getElementById('epC').value.trim(),m:document.getElementById('epM').value,pm:document.getElementById('epPM').value.trim(),co:document.getElementById('epCO').value.trim(),sc:document.getElementById('epSC').value.split(',').map(s=>s.trim()).filter(Boolean),notes:document.getElementById('epNo').value.trim()});
await bSM();toast('\u2713 Practice saved');goBack()}
async function delPrc(){if(!_epid||!confirm('Delete this practice?'))return;await D('practices',_epid);await bSM();toast('Deleted');goBack()}
async function addWG(){const n=document.getElementById('nWG').value.trim();if(!n)return;const d=await G('settings','wxg')||{k:'wxg',g:[]};d.g.push(n);await P('settings',d);document.getElementById('nWG').value='';toast('\u2713 Added');renders.wxg()}
async function rmWG(i){const d=await G('settings','wxg');if(!d)return;d.g.splice(i,1);await P('settings',d);renders.wxg()}
async function savePin(){const p=document.getElementById('sP').value,c=document.getElementById('sPC').value;if(p.length<4){toast('PIN must be 4+ digits');return}if(p!==c){toast('PINs do not match');return}await P('settings',{k:'pin',v:p});toast('\u2713 PIN saved');document.getElementById('sP').value='';document.getElementById('sPC').value=''}
async function rmPin(){await D('settings','pin');toast('PIN removed')}
async function expB(){const d={schema:'wcc.backup.v15.0',exported:new Date().toISOString(),entries:await A('entries'),practices:await A('practices'),settings:await A('settings'),pending:await A('pending'),commlog:await A('commlog')};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='wcc-backup-'+tdy()+'.json';a.click();URL.revokeObjectURL(u);toast('\ud83d\udce4 Exported')}
async function impB(ev){const f=ev.target.files[0];if(!f)return;try{const t=await f.text(),d=JSON.parse(t);if(!d.schema?.startsWith('wcc.backup')){toast('Invalid file');return}
if(d.entries){await C('entries');for(const e of d.entries)await P('entries',e)}if(d.practices){await C('practices');for(const p of d.practices)await P('practices',p)}if(d.settings)for(const s of d.settings)await P('settings',s);if(d.pending){await C('pending');for(const p of d.pending)await P('pending',p)}if(d.commlog){await C('commlog');for(const c of d.commlog)await P('commlog',c)}
await bSM();toast('\ud83d\udce5 Restored');nav('home')}catch(e){toast('Failed: '+e.message)}ev.target.value=''}
async function clrAll(){if(!confirm('Delete ALL data? Cannot be undone.'))return;if(!confirm('Absolutely sure?'))return;await C('entries');await C('pending');await C('commlog');toast('\ud83d\uddd1 Cleared');nav('home')}

// Service Worker
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});
// Start
init().catch(e=>console.error('Init:',e));
</script>
</body>
</html>
